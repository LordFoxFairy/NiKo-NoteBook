# ç¬¬6ç«  SDXLå®æˆ˜ç²¾é€š

> æ·±åº¦æŒæ¡Stable Diffusion XLï¼Œç”ŸæˆçœŸäººç…§ç‰‡çº§å›¾åƒ
>
> **å­¦ä¹ ç›®æ ‡**:
> - ç†è§£SDXLæ¶æ„é©æ–°
> - æŒæ¡Base+RefineråŒæ¨¡å‹å·¥ä½œæµ
> - ç²¾é€šçœŸäººå›¾åƒç”ŸæˆæŠ€å·§
> - ä¼˜åŒ–é«˜åˆ†è¾¨ç‡è¾“å‡ºè´¨é‡

---

## 6.1 SDXLæ¶æ„æ·±åº¦è§£æ

### 6.1.1 SDXL vs SD 1.5 æ ¸å¿ƒå·®å¼‚

#### æ¶æ„å¯¹æ¯”è¡¨

| ç»´åº¦ | SD 1.5 | SDXL | æå‡ |
|------|--------|------|------|
| **å‚æ•°é‡** | 0.98B | 3.5B | 3.6x |
| **U-Neté€šé“** | 320 | 640 | 2x |
| **CLIPæ¨¡å‹** | ViT-L/14 | ViT-L + OpenCLIP ViT-G | åŒç¼–ç å™¨ |
| **CLIPåµŒå…¥ç»´åº¦** | 768 | 1280 (ViT-G) | 1.67x |
| **æ½œç©ºé—´é€šé“** | 4 | 4 | ç›¸åŒ |
| **è®­ç»ƒåˆ†è¾¨ç‡** | 512Ã—512 | 1024Ã—1024 | 4xåƒç´  |
| **æ¨¡å‹å¤§å°** | 4GB | 6.5GB | 1.6x |
| **æ¨ç†é€Ÿåº¦** | åŸºå‡† | 0.6x | æ…¢40% |
| **å›¾åƒè´¨é‡** | â­â­â­ | â­â­â­â­â­ | æ˜¾è‘—æå‡ |

---

### 6.1.2 SDXL U-Netæ¶æ„åˆ›æ–°

#### SD 1.5 U-Net

```
ä¼ ç»ŸU-Netç»“æ„:
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”Œâ”€â”€â”€â†’â”‚  Down  â”‚â”€â”€â”€â”
    â”‚    â”‚ Block1 â”‚   â”‚
Input    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”œâ”€â”€â”€â†’â”‚  Down  â”‚â”€â”€â”€â”¤
    â”‚    â”‚ Block2 â”‚   â”‚
    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚         â‹®        â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â””â”€â”€â”€â†’â”‚ Bottom â”‚   â”‚
         â”‚ Block  â”‚   â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â”‚
              â”‚       â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”   â”‚
         â”‚   Up   â”‚â—„â”€â”€â”¤
         â”‚ Block1 â”‚   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
         â”‚   Up   â”‚â—„â”€â”€â”˜
         â”‚ Block2 â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
              â–¼
          Output
```

#### SDXL U-Netå¢å¼º

**åˆ›æ–°1: æ›´æ·±çš„ç½‘ç»œ**

$$
\text{æ·±åº¦}_{\text{SDXL}} = 2 \times \text{æ·±åº¦}_{\text{SD1.5}}
$$

```python
# SD 1.5: ä¸‹é‡‡æ ·3å±‚
Down1: 320 channels
Down2: 640 channels
Down3: 1280 channels

# SDXL: ä¸‹é‡‡æ ·4å±‚
Down1: 640 channels
Down2: 1280 channels
Down3: 1920 channels
Down4: 2560 channels  # æ–°å¢
```

**åˆ›æ–°2: Transformerå±‚åŠ å€**

$$
\text{Attentionå±‚}_{\text{SDXL}} = 2 \times \text{Attentionå±‚}_{\text{SD1.5}}
$$

æ¯ä¸ªResBlockåå¢åŠ äº†æ›´å¤šçš„Self-Attentionå’ŒCross-Attentionå±‚ã€‚

---

### 6.1.3 åŒCLIPç¼–ç å™¨æ¶æ„

#### å•ç¼–ç å™¨ (SD 1.5)

$$
\begin{aligned}
\text{tokens} &= \text{Tokenize}(P) \\
c &= \text{CLIP}_{\text{ViT-L}}(\text{tokens}) \in \mathbb{R}^{77 \times 768}
\end{aligned}
$$

#### åŒç¼–ç å™¨ (SDXL)

$$
\begin{aligned}
c_1 &= \text{CLIP}_{\text{ViT-L}}(\text{tokens}) \in \mathbb{R}^{77 \times 768} \\
c_2 &= \text{OpenCLIP}_{\text{ViT-G}}(\text{tokens}) \in \mathbb{R}^{77 \times 1280} \\
c &= [c_1; c_2] \in \mathbb{R}^{77 \times 2048}
\end{aligned}
$$

**ä¼˜åŠ¿**:
- ViT-L: æ“…é•¿ç†è§£ç®€å•æè¿°
- ViT-G: æ“…é•¿ç†è§£ç»†èŠ‚å’Œå¤æ‚è¯­ä¹‰
- è”åˆç¼–ç : æ›´ç²¾å‡†çš„æ–‡æœ¬ç†è§£

---

### 6.1.4 åŠ é€Ÿé‡‡æ ·è°ƒåº¦å™¨

#### Karraså™ªå£°è°ƒåº¦

SD 1.5ä½¿ç”¨çº¿æ€§å™ªå£°è°ƒåº¦ï¼š
$$
\beta_t = \beta_{\min} + (\beta_{\max} - \beta_{\min}) \cdot \frac{t}{T}
$$

SDXLé»˜è®¤ä½¿ç”¨Karrasè°ƒåº¦ï¼š
$$
\sigma(t) = \sigma_{\min}^{1-\rho} \cdot \sigma_{\max}^{\rho}
$$

å…¶ä¸­ï¼š
$$
\rho = \frac{t}{T}, \quad \sigma_{\min} = 0.029, \quad \sigma_{\max} = 14.6
$$

**æ•ˆæœ**:
- å‰æœŸå»å™ªæ›´æ¿€è¿›ï¼ˆå¿«é€Ÿå½¢æˆç»“æ„ï¼‰
- åæœŸå»å™ªæ›´ç»†è…»ï¼ˆç²¾ä¿®ç»†èŠ‚ï¼‰
- å®æµ‹20æ­¥SDXL â‰ˆ 30æ­¥SD1.5

---

## 6.2 SDXL Baseæ¨¡å‹å®æˆ˜

### 6.2.1 æ¨¡å‹ä¸‹è½½ä¸é…ç½®

#### å®˜æ–¹æ¨¡å‹

```bash
# SDXL Base 1.0
URL: https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0
æ–‡ä»¶: sd_xl_base_1.0.safetensors
å¤§å°: 6.94GB
MD5: 31e35c80fc4829d14f90153f4c74cd59

# SDXL VAE (ä¿®å¤ç‰ˆ)
URL: https://huggingface.co/stabilityai/sdxl-vae
æ–‡ä»¶: sdxl_vae.safetensors
å¤§å°: 335MB
ç”¨é€”: ä¿®å¤åŸç‰ˆVAEçš„NaNé—®é¢˜

# SDXL Refiner 1.0
URL: https://huggingface.co/stabilityai/stable-diffusion-xl-refiner-1.0
æ–‡ä»¶: sd_xl_refiner_1.0.safetensors
å¤§å°: 6.08GB
```

#### ç¬¬ä¸‰æ–¹ä¼˜åŒ–æ¨¡å‹ï¼ˆçœŸäººä¸“ç”¨ï¼‰â­â­â­â­â­

```bash
ã€æ¨è1: RealVisXL V4.0ã€‘
ä¸‹è½½: https://civitai.com/models/139562/realvisxl-v40
ç‰¹ç‚¹: çœŸäººç…§ç‰‡çº§ï¼Œäºšæ´²é¢å­”ä¼˜ç§€ï¼Œå¥èº«å›¾åƒè´¨é‡æœ€ä½³
æ–‡ä»¶: RealVisXL_V4.0.safetensors (6.94GB)

ã€æ¨è2: DreamShaper XLã€‘
ä¸‹è½½: https://civitai.com/models/112902/dreamshaper-xl
ç‰¹ç‚¹: å¹³è¡¡çœŸå®æ„Ÿå’Œè‰ºæœ¯æ€§
æ–‡ä»¶: dreamshaperXL_v21TurboDPMSDE.safetensors (6.94GB)

ã€æ¨è3: JuggernautXLã€‘
ä¸‹è½½: https://civitai.com/models/133005/juggernaut-xl
ç‰¹ç‚¹: é€šç”¨åœºæ™¯ï¼Œç»†èŠ‚ä¸°å¯Œ
æ–‡ä»¶: juggernautXL_v8Rundiffusion.safetensors (6.94GB)
```

---

### 6.2.2 WebUIé…ç½®SDXL

#### å¯åŠ¨å‚æ•°ä¼˜åŒ–

```bash
# webui-user.bat (Windows)
set COMMANDLINE_ARGS=--xformers --medvram --opt-sdp-attention

# å‚æ•°è¯´æ˜:
--xformers            # ä½¿ç”¨xFormersåŠ é€Ÿï¼ˆå‡å°‘æ˜¾å­˜30%ï¼Œæé€Ÿ20%ï¼‰
--medvram             # ä¸­ç­‰æ˜¾å­˜ä¼˜åŒ–ï¼ˆ8-12GBæ˜¾å¡å¿…å¤‡ï¼‰
--opt-sdp-attention   # ä½¿ç”¨PyTorch 2.0ä¼˜åŒ–æ³¨æ„åŠ›ï¼ˆå‡å°‘æ˜¾å­˜15%ï¼‰

# 6GBæ˜¾å¡ï¼ˆæé™ä¼˜åŒ–ï¼‰
set COMMANDLINE_ARGS=--lowvram --xformers --opt-sdp-attention --no-half-vae
```

#### æ˜¾å­˜å ç”¨å®æµ‹

$$
\text{VRAM}_{\text{SDXL}} = \text{Model} + \text{Compute} + \text{VAE}
$$

| åˆ†è¾¨ç‡ | æ— ä¼˜åŒ– | --medvram | --lowvram |
|--------|--------|-----------|-----------|
| 512Ã—512 | 8.5GB | 6.2GB | 4.8GB |
| 768Ã—1024 | 10.2GB | 7.4GB | 5.9GB |
| 1024Ã—1024 | 11.8GB | 8.6GB | 6.8GB |
| 1536Ã—1536 | 16.2GB | 12.1GB | 9.5GB |

---

### 6.2.3 ç¬¬ä¸€å¼ SDXLå›¾åƒç”Ÿæˆ

#### WebUIæ ‡å‡†æµç¨‹

```
ã€æ¨¡å‹é€‰æ‹©ã€‘
Checkpoint: RealVisXL_V4.0.safetensors
VAE: sdxl_vae.safetensors

ã€æ­£é¢æç¤ºè¯ã€‘
masterpiece, best quality, ultra detailed, 8k uhd,
RAW photo, professional photography,
1 girl, 25 years old, asian woman,
(athletic body:1.3), (toned abs:1.2), fit physique,
beautiful face, (detailed eyes:1.2), natural skin texture,
long black hair, high ponytail,
(sports bra:1.2), (tight yoga pants:1.2), sneakers,
standing in modern gym,
(professional gym equipment:1.1), mirrors in background,
(cinematic lighting:1.3), natural lighting from windows,
depth of field, bokeh,
photorealistic, highly detailed skin, realistic

ã€è´Ÿé¢æç¤ºè¯ã€‘
(deformed, distorted, disfigured:1.5),
(bad anatomy, wrong anatomy, extra limb:1.4),
(bad hands, bad fingers, missing fingers, extra fingers:1.4),
(ugly, bad face, bad eyes:1.3),
(fat, overweight, obese, skinny, thin:1.3),
(low quality, worst quality, normal quality:1.4),
(blurry, out of focus, grainy, pixelated:1.3),
(watermark, text, logo, signature, username:1.3),
(oversaturated, undersaturated:1.2),
painting, cartoon, anime, 3d render

ã€é‡‡æ ·å‚æ•°ã€‘
Sampling method: DPM++ 2M Karras
Sampling steps: 25
Width: 832
Height: 1216  (çº¦ç­‰äº3:4æ¯”ä¾‹)
CFG Scale: 7
Seed: -1 (é¦–æ¬¡éšæœº)

ã€é«˜çº§è®¾ç½®ã€‘
Clip skip: 2  (SDXLæ¨è)
ENSD: 31337  (å™ªå£°ç§å­ï¼Œå›ºå®šå¯å¤ç°)
```

#### SDXLæ¨èåˆ†è¾¨ç‡

SDXLåœ¨ä»¥ä¸‹åˆ†è¾¨ç‡è®­ç»ƒè¿‡ï¼Œæ•ˆæœæœ€ä½³ï¼š

```python
# å®˜æ–¹è®­ç»ƒåˆ†è¾¨ç‡ï¼ˆå®½Ã—é«˜ï¼‰
SDXL_RESOLUTIONS = [
    (1024, 1024),  # 1:1  æ–¹å½¢ â­â­â­â­â­
    (1152, 896),   # 9:7  æ¨ªå‘
    (896, 1152),   # 7:9  çºµå‘ â­â­â­â­â­ (äººåƒ)
    (1216, 832),   # 19:13 æ¨ªå‘
    (832, 1216),   # 13:19 çºµå‘ â­â­â­â­â­ (å…¨èº«)
    (1344, 768),   # 7:4  å®½å±
    (768, 1344),   # 4:7  è¶…çºµå‘
    (1536, 640),   # 12:5 è¶…å®½
    (640, 1536),   # 5:12 è¶…é«˜
]

# æ¨èä½¿ç”¨åŸåˆ™
æ€»åƒç´  â‰ˆ 1024Ã—1024 = 1,048,576
å®½Ã—é«˜ â‰ˆ 1Måƒç´ 
```

**é¿å…çš„åˆ†è¾¨ç‡**:
```
âŒ 512Ã—512   (å¤ªå°ï¼Œç»†èŠ‚ä¸è¶³)
âŒ 2048Ã—2048 (è¶…å‡ºè®­ç»ƒåˆ†è¾¨ç‡ï¼Œå¯èƒ½é‡å¤)
âŒ 768Ã—768   (éè®­ç»ƒæ¯”ä¾‹ï¼Œè´¨é‡ä¸‹é™)
```

---

### 6.2.4 æç¤ºè¯ä¼˜åŒ–ï¼ˆSDXLä¸“ç”¨ï¼‰

#### SDXLæç¤ºè¯ç‰¹ç‚¹

**1. æ›´å¼ºçš„è‡ªç„¶è¯­è¨€ç†è§£**

```
SD 1.5é£æ ¼ï¼ˆæ ‡ç­¾å¼ï¼‰:
1girl, athletic body, sports bra, gym

SDXLé£æ ¼ï¼ˆè‡ªç„¶æè¿°ï¼‰âœ…:
A professional photograph of a fit young woman
wearing athletic sportswear in a modern gym,
captured with professional lighting and depth of field
```

**2. æ”¯æŒæ›´é•¿çš„æç¤ºè¯**

```
SD 1.5: 77 tokensé™åˆ¶
SDXL: 77 tokens Ã— 2ç¼–ç å™¨ = æ›´å¼ºç†è§£

å¯ä»¥å†™150-200è¯çš„è¯¦ç»†æè¿°
```

**3. ä¸éœ€è¦è¿‡å¤šè´¨é‡è¯**

```
SD 1.5å¿…å¤‡:
masterpiece, best quality, ultra detailed, 8k

SDXLå¯ç®€åŒ–:
professional photography, highly detailed

åŸå› : SDXLè®­ç»ƒæ•°æ®è´¨é‡æ›´é«˜ï¼Œé»˜è®¤ç”Ÿæˆè´¨é‡å¥½
```

#### çœŸäººå¥èº«åœºæ™¯SDXLæç¤ºè¯æ¨¡æ¿

```
ã€æ¨¡æ¿1: åŸºç¡€ç‰ˆã€‘â­â­â­â­â­
RAW photo, professional photography,
1 girl, 25 years old, asian fitness model,
(athletic body:1.3), (toned abs:1.2),
long black hair, ponytail,
sports bra, yoga pants,
standing in modern gym,
natural lighting, depth of field,
photorealistic, highly detailed

ã€æ¨¡æ¿2: è¯¦ç»†æè¿°ç‰ˆã€‘â­â­â­â­â­
A stunning professional photograph of a beautiful asian fitness model
in her mid-twenties, showcasing her athletic physique.
She has a (toned, muscular body:1.3) with (defined abs:1.2),
long flowing black hair tied in a high ponytail.
Wearing a sleek black (sports bra:1.2) and matching (yoga pants:1.2),
she stands confidently in a modern, well-equipped gym.
The scene is illuminated by (natural lighting streaming through large windows:1.2),
creating a (cinematic atmosphere:1.2) with beautiful bokeh in the background.
Shot with (professional photography equipment:1.1),
capturing (highly detailed skin texture) and (realistic muscle definition).
8k resolution, photorealistic quality.

ã€æ¨¡æ¿3: åŠ¨ä½œå§¿åŠ¿ç‰ˆã€‘â­â­â­â­â­
RAW photo, professional sports photography,
1 girl, asian athlete, (athletic build:1.3),
(performing squat exercise:1.3), (proper form:1.2),
muscular thighs, toned glutes, strong legs,
focused expression, determined look,
sports bra, athletic shorts,
modern gym environment, (barbell on shoulders:1.1),
(side angle view:1.2), full body shot,
(dynamic pose:1.2), action shot,
dramatic lighting, professional lighting setup,
highly detailed, photorealistic, 8k uhd

ã€æ¨¡æ¿4: ç‘œä¼½åœºæ™¯ç‰ˆã€‘â­â­â­â­â­
Professional photograph of a serene yoga session,
1 girl, flexible asian woman, (yoga instructor:1.2),
(performing tree pose:1.3), (perfect balance:1.2),
lean athletic body, graceful posture,
white yoga outfit, yoga mat,
peaceful yoga studio, (plants in background:1.1),
(soft natural lighting:1.3), warm atmosphere,
(minimal background:1.2), calm environment,
photorealistic, highly detailed, shallow depth of field
```

---

## 6.3 SDXL Refinerå·¥ä½œæµ

### 6.3.1 Base + RefineråŸç†

#### ä¸ºä»€ä¹ˆéœ€è¦Refinerï¼Ÿ

**é—®é¢˜**: Baseæ¨¡å‹ç‹¬ç«‹ç”Ÿæˆçš„å›¾åƒï¼Œåœ¨é«˜é¢‘ç»†èŠ‚ï¼ˆçš®è‚¤çº¹ç†ã€å¤´å‘ç»†èŠ‚ï¼‰ä¸Šç•¥æ˜¾ä¸è¶³ã€‚

**è§£å†³**: Refineræ¨¡å‹ä¸“é—¨è®­ç»ƒç”¨äºç²¾ä¿®ç»†èŠ‚ã€‚

#### æ•°å­¦åŸç†

å®Œæ•´ç”Ÿæˆè¿‡ç¨‹åˆ†ä¸ºä¸¤é˜¶æ®µï¼š

$$
\begin{aligned}
\text{Stage 1 (Base):} & \\
z_T &\sim \mathcal{N}(0, I) \\
z_{\alpha T} &= \text{Denoise}_{\text{Base}}(z_T, c, t \in [T, \alpha T])
\end{aligned}
$$

$$
\begin{aligned}
\text{Stage 2 (Refiner):} & \\
z_0 &= \text{Denoise}_{\text{Refiner}}(z_{\alpha T}, c, t \in [\alpha T, 0])
\end{aligned}
$$

å…¶ä¸­ $\alpha$ æ˜¯åˆ‡æ¢ç‚¹ï¼Œé€šå¸¸ $\alpha = 0.2 \sim 0.3$ï¼ˆå³Baseå®Œæˆ70-80%ï¼‰ã€‚

#### åˆ‡æ¢æ—¶æœºå¯¹æ¯”

```python
# å®æµ‹ä¸åŒåˆ‡æ¢ç‚¹çš„æ•ˆæœ

Î± = 0.2 (Baseå®Œæˆ80%):
  - Baseç”Ÿæˆä¸»ä½“ç»“æ„ã€æ„å›¾
  - Refinerç²¾ä¿®20%ç»†èŠ‚
  æ•ˆæœ: â­â­â­â­â­ (æ¨è)

Î± = 0.3 (Baseå®Œæˆ70%):
  - Refinerå‚ä¸æ›´å¤š
  æ•ˆæœ: â­â­â­â­ (ç»†èŠ‚æ›´ç²¾ï¼Œä½†å¯èƒ½æ”¹å˜é£æ ¼)

Î± = 0.4 (Baseå®Œæˆ60%):
  - Refinerä¸»å¯¼åæœŸ
  æ•ˆæœ: â­â­â­ (å¯èƒ½è¿‡åº¦ç²¾ä¿®ï¼Œå¤±å»è‡ªç„¶æ„Ÿ)

Î± = 0.1 (Baseå®Œæˆ90%):
  - Refinerä»…åšè¡¨é¢ä¿®é¥°
  æ•ˆæœ: â­â­â­ (Refinerä½œç”¨ä¸æ˜æ˜¾)
```

**æ¨èé…ç½®**:
```yaml
æ€»æ­¥æ•°: 30
Base: 0-24æ­¥ (80%)  â† æ¨è
Refiner: 24-30æ­¥ (20%)
```

---

### 6.3.2 WebUI Refinerè®¾ç½®

#### æ–¹æ³•1: Refineræ ‡ç­¾é¡µï¼ˆç®€å•ï¼‰

```
1. å‹¾é€‰ "Refine" æ ‡ç­¾

2. è®¾ç½®Refinerå‚æ•°:
   Refiner model: sd_xl_refiner_1.0.safetensors
   Switch at: 0.8  (åˆ‡æ¢ç‚¹ï¼Œ0.8 = Baseå®Œæˆ80%)

3. å…¶ä»–å‚æ•°ä¿æŒä¸Baseä¸€è‡´:
   Steps: 30
   Sampler: DPM++ 2M Karras
   CFG: 7

4. Generateç”Ÿæˆ
```

#### æ–¹æ³•2: img2imgæ³•ï¼ˆé«˜çº§ï¼‰

```
æµç¨‹:
Baseç”Ÿæˆ (30æ­¥) â†’ ä¿å­˜å›¾åƒ â†’ img2imgåŠ è½½ â†’ Refineré‡ç»˜

Baseé˜¶æ®µ:
  Checkpoint: SDXL Base
  Steps: 30
  ç”Ÿæˆå›¾åƒ

Refineré˜¶æ®µ:
  åˆ‡æ¢Checkpoint: SDXL Refiner
  img2imgæ ‡ç­¾é¡µ:
    ä¸Šä¼ Baseç”Ÿæˆçš„å›¾åƒ
    Denoising strength: 0.2-0.3
    Steps: 20
  ç”Ÿæˆç²¾ä¿®å›¾åƒ
```

---

### 6.3.3 ComfyUI Refinerå·¥ä½œæµï¼ˆä¼ä¸šçº§ï¼‰

#### å®Œæ•´å·¥ä½œæµèŠ‚ç‚¹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Checkpoint     â”‚
â”‚ (SDXL Base)         â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚MODELâ”‚CLIP â”‚VAE
    â”‚     â”‚     â”‚
    â”‚     â–¼     â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚CLIP Text â”‚
    â”‚  â”‚(Positive)â”‚
    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚CLIP Text â”‚
    â”‚  â”‚(Negative)â”‚
    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚  Empty   â”‚
    â”‚  â”‚ Latent   â”‚
    â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â–¼       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KSampler Advanced   â”‚
â”‚ (Baseé‡‡æ ·)          â”‚
â”‚ start=0, end=24     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚LATENT
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load Checkpoint     â”‚
â”‚ (SDXL Refiner)      â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
    â”‚MODELâ”‚CLIP â”‚VAE
    â–¼     â–¼     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KSampler Advanced   â”‚
â”‚ (Refineré‡‡æ ·)       â”‚
â”‚ start=24, end=30    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚LATENT
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   VAE    â”‚
    â”‚  Decode  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Save   â”‚
    â”‚  Image   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®Œæ•´JSONå·¥ä½œæµ

```json
{
  "last_node_id": 12,
  "last_link_id": 20,
  "nodes": [
    {
      "id": 1,
      "type": "CheckpointLoaderSimple",
      "pos": [50, 50],
      "size": [300, 100],
      "properties": {},
      "widgets_values": ["sd_xl_base_1.0.safetensors"]
    },
    {
      "id": 2,
      "type": "CLIPTextEncode",
      "pos": [400, 50],
      "size": [400, 200],
      "properties": {},
      "widgets_values": [
        "RAW photo, professional photography,\n1 girl, 25yo, asian fitness model,\n(athletic body:1.3), (toned abs:1.2),\nlong black hair, ponytail,\nsports bra, yoga pants,\nmodern gym, natural lighting,\nphotorealistic, highly detailed"
      ]
    },
    {
      "id": 3,
      "type": "CLIPTextEncode",
      "pos": [400, 300],
      "size": [400, 150],
      "properties": {},
      "widgets_values": [
        "(deformed, ugly, bad anatomy:1.5),\n(low quality, blurry:1.4),\nwatermark"
      ]
    },
    {
      "id": 4,
      "type": "EmptyLatentImage",
      "pos": [50, 200],
      "size": [300, 110],
      "properties": {},
      "widgets_values": [1024, 1024, 1]
    },
    {
      "id": 5,
      "type": "KSamplerAdvanced",
      "pos": [850, 50],
      "size": [300, 330],
      "properties": {},
      "widgets_values": [
        "enable",      // add_noise
        123456,        // seed
        "fixed",       // control_after_generate
        30,            // steps
        7.0,           // cfg
        "dpmpp_2m_karras",  // sampler_name
        "karras",      // scheduler
        0,             // start_at_step
        24,            // end_at_step (80% = 24/30)
        "enable"       // return_with_leftover_noise
      ]
    },
    {
      "id": 6,
      "type": "CheckpointLoaderSimple",
      "pos": [50, 400],
      "size": [300, 100],
      "properties": {},
      "widgets_values": ["sd_xl_refiner_1.0.safetensors"]
    },
    {
      "id": 7,
      "type": "CLIPTextEncode",
      "pos": [400, 500],
      "size": [400, 200],
      "properties": {},
      "widgets_values": [
        "RAW photo, professional photography,\n1 girl, athletic body, gym,\nhighly detailed, photorealistic"
      ]
    },
    {
      "id": 8,
      "type": "CLIPTextEncode",
      "pos": [400, 750],
      "size": [400, 150],
      "properties": {},
      "widgets_values": [
        "(deformed, ugly:1.5),\n(low quality, blurry:1.4)"
      ]
    },
    {
      "id": 9,
      "type": "KSamplerAdvanced",
      "pos": [850, 400],
      "size": [300, 330],
      "properties": {},
      "widgets_values": [
        "disable",     // add_noise (ä¸æ·»åŠ æ–°å™ªå£°)
        123456,        // seed (ä¿æŒä¸€è‡´)
        "fixed",
        30,            // steps
        7.0,           // cfg
        "dpmpp_2m_karras",
        "karras",
        24,            // start_at_step
        30,            // end_at_step (100%)
        "disable"      // return_with_leftover_noise
      ]
    },
    {
      "id": 10,
      "type": "VAEDecode",
      "pos": [1200, 400],
      "size": [200, 50],
      "properties": {}
    },
    {
      "id": 11,
      "type": "SaveImage",
      "pos": [1450, 400],
      "size": [300, 100],
      "properties": {},
      "widgets_values": ["sdxl_refiner_output"]
    }
  ],
  "links": [
    [1, 1, 0, 5, 0, "MODEL"],      // Base MODEL â†’ Base Sampler
    [2, 1, 1, 2, 0, "CLIP"],       // Base CLIP â†’ Positive
    [3, 1, 1, 3, 0, "CLIP"],       // Base CLIP â†’ Negative
    [4, 2, 0, 5, 1, "CONDITIONING"], // Positive â†’ Base Sampler
    [5, 3, 0, 5, 2, "CONDITIONING"], // Negative â†’ Base Sampler
    [6, 4, 0, 5, 3, "LATENT"],     // Empty Latent â†’ Base Sampler
    [7, 5, 0, 9, 3, "LATENT"],     // Base Output â†’ Refiner Sampler
    [8, 6, 0, 9, 0, "MODEL"],      // Refiner MODEL â†’ Refiner Sampler
    [9, 6, 1, 7, 0, "CLIP"],       // Refiner CLIP â†’ Positive
    [10, 6, 1, 8, 0, "CLIP"],      // Refiner CLIP â†’ Negative
    [11, 7, 0, 9, 1, "CONDITIONING"], // Positive â†’ Refiner Sampler
    [12, 8, 0, 9, 2, "CONDITIONING"], // Negative â†’ Refiner Sampler
    [13, 9, 0, 10, 0, "LATENT"],   // Refiner Output â†’ VAE Decode
    [14, 6, 2, 10, 1, "VAE"],      // Refiner VAE â†’ VAE Decode
    [15, 10, 0, 11, 0, "IMAGE"]    // Image â†’ Save
  ]
}
```

**ä¿å­˜ä¸ä½¿ç”¨**:
```bash
# ä¿å­˜å·¥ä½œæµ
ComfyUIç•Œé¢ â†’ å³é”® â†’ Save Workflow
ä¿å­˜ä¸º: sdxl_base_refiner.json

# åŠ è½½å·¥ä½œæµ
æ‹–æ‹½JSONæ–‡ä»¶åˆ°ComfyUIç”»å¸ƒ
æˆ–
Load â†’ é€‰æ‹©JSONæ–‡ä»¶
```

---

## 6.4 çœŸäººå›¾åƒè´¨é‡ä¼˜åŒ–

### 6.4.1 çš®è‚¤è´¨æ„Ÿä¼˜åŒ–

#### é—®é¢˜ï¼šAIç”Ÿæˆçš„çš®è‚¤è¿‡äºå…‰æ»‘

**åŸå› åˆ†æ**:
- è®­ç»ƒæ•°æ®ä¸­æœ‰å¤§é‡ç¾é¢œåçš„ç…§ç‰‡
- VAEè§£ç å™¨å€¾å‘äºå¹³æ»‘åŒ–

**è§£å†³æ–¹æ¡ˆ**:

```
ã€æ–¹æ¡ˆ1: æç¤ºè¯å¼ºè°ƒã€‘â­â­â­â­
æ·»åŠ å…³é”®è¯:
realistic skin texture, (detailed skin pores:1.1),
natural skin, (skin imperfections:0.9),
subtle skin details, professional photography

ã€æ–¹æ¡ˆ2: ä½¿ç”¨ä¸“ç”¨VAEã€‘â­â­â­â­â­
ä¸‹è½½SDXL VAE (ä¿®å¤ç‰ˆ):
sdxl_vae.safetensors

æ•ˆæœ: çš®è‚¤çº¹ç†æ›´è‡ªç„¶ï¼Œé¿å…è¿‡åº¦å¹³æ»‘

ã€æ–¹æ¡ˆ3: Refinerç²¾ä¿®ã€‘â­â­â­â­â­
ä½¿ç”¨Refineræ¨¡å‹:
ä¸“é—¨ä¼˜åŒ–ç»†èŠ‚çº¹ç†

ã€æ–¹æ¡ˆ4: åå¤„ç†ã€‘â­â­â­
ä½¿ç”¨é”åŒ–å·¥å…·:
è½»å¾®é”åŒ– â†’ å¢å¼ºç»†èŠ‚
```

---

### 6.4.2 æ‰‹éƒ¨ç»†èŠ‚ä¿®å¤ï¼ˆAIçš„æœ€å¤§éš¾ç‚¹ï¼‰

#### ä¸ºä»€ä¹ˆæ‰‹éƒ¨å®¹æ˜“å‡ºé”™ï¼Ÿ

**åŸå› **:
1. æ‰‹éƒ¨è‡ªç”±åº¦é«˜ï¼ˆ20+å…³èŠ‚ï¼‰
2. è®­ç»ƒæ•°æ®ä¸­æ‰‹éƒ¨é®æŒ¡ã€æ¨¡ç³Šå¤š
3. æ½œç©ºé—´å‹ç¼©æŸå¤±ç»†èŠ‚

**è§£å†³æ–¹æ¡ˆ**:

```
ã€æ–¹æ¡ˆ1: æç¤ºè¯é¿å¼€æ‰‹éƒ¨ã€‘â­â­â­â­â­
hands behind back,
hands on hips,
arms crossed,
holding equipment (æ¡ç€å™¨æ¢°ï¼Œå›ºå®šå§¿åŠ¿)

ã€æ–¹æ¡ˆ2: è´Ÿé¢æç¤ºè¯å¼ºåŒ–ã€‘â­â­â­â­
Negative:
(bad hands:1.5),
(mutated hands, poorly drawn hands:1.5 ),
(extra fingers, fewer fingers:1.5),
(fused fingers, abnormal fingers:1.4)

ã€æ–¹æ¡ˆ3: ä½¿ç”¨ControlNetã€‘â­â­â­â­â­(åç»­ç« èŠ‚è¯¦è§£)
å…ˆç”Ÿæˆå›¾åƒ â†’ æ‰‹å·¥ä¿®æ­£æ‰‹éƒ¨ â†’ ControlNeté‡ç»˜

ã€æ–¹æ¡ˆ4: Inpaintingä¿®å¤ã€‘â­â­â­â­
å‘ç°æ‰‹éƒ¨é”™è¯¯ â†’ å±€éƒ¨é‡ç»˜æ‰‹éƒ¨åŒºåŸŸ

ã€æ–¹æ¡ˆ5: æé«˜åˆ†è¾¨ç‡ã€‘â­â­â­
æ›´é«˜åˆ†è¾¨ç‡ â†’ æ‰‹éƒ¨ç»†èŠ‚æ›´å……åˆ†
æ¨è: 1216Ã—832 ä»¥ä¸Š
```

---

### 6.4.3 è‚Œè‚‰çº¿æ¡è¡¨ç°

#### å¥èº«å›¾åƒçš„æ ¸å¿ƒéœ€æ±‚

**æŒ‘æˆ˜**: AIé»˜è®¤å€¾å‘äºå¹³æ»‘ã€æŸ”å’Œçš„å¥³æ€§å½¢è±¡ï¼Œè‚Œè‚‰çº¿æ¡ä¸æ˜æ˜¾ã€‚

**ä¼˜åŒ–ç­–ç•¥**:

```yaml
ã€ç­–ç•¥1: ç²¾å‡†æç¤ºè¯ã€‘â­â­â­â­â­
(athletic body:1.3),          # å¼ºè°ƒå¥ç¾èº«æ
(toned muscles:1.2),          # ç´§è‡´è‚Œè‚‰
(defined abs:1.3),            # æ˜æ˜¾è…¹è‚Œçº¿æ¡
(muscular legs:1.2),          # è‚Œè‚‰è…¿éƒ¨
(six pack abs:1.2),           # å…­å—è…¹è‚Œ
(visible muscle definition:1.2), # å¯è§è‚Œè‚‰çº¿æ¡
lean physique,                # ç²¾ç˜¦ä½“æ ¼
low body fat,                 # ä½ä½“è„‚

ã€ç­–ç•¥2: å…‰å½±å¼ºåŒ–ã€‘â­â­â­â­â­
(dramatic lighting:1.2),      # æˆå‰§æ€§å…‰çº¿
(side lighting:1.2),          # ä¾§å…‰ï¼ˆå¼ºåŒ–ç«‹ä½“æ„Ÿï¼‰
(rim lighting:1.1),           # è½®å»“å…‰
strong shadows,               # å¼ºçƒˆé˜´å½±
(cinematic lighting:1.2),     # ç”µå½±æ„Ÿå…‰çº¿

ã€ç­–ç•¥3: å‚è€ƒå›¾åƒã€‘â­â­â­â­
ä½¿ç”¨img2img:
ä¸Šä¼ çœŸå®å¥èº«ç…§ç‰‡ â†’ Denoising 0.5-0.6
ä¿ç•™è‚Œè‚‰ç»“æ„ï¼ŒAIæ¶¦è‰²

ã€ç­–ç•¥4: LoRAå¾®è°ƒã€‘â­â­â­â­â­(é«˜çº§)
è®­ç»ƒä¸“ç”¨LoRA:
æ”¶é›†50-100å¼ å¥èº«ç…§ç‰‡ â†’ è®­ç»ƒLoRA
å›ºå®šè‚Œè‚‰çº¿æ¡é£æ ¼
```

#### å®Œæ•´æç¤ºè¯ç¤ºä¾‹

```
ã€æè‡´è‚Œè‚‰çº¿æ¡ç‰ˆã€‘
RAW photo, professional fitness photography,
1 girl, 25 years old, asian female bodybuilder,
(extremely athletic physique:1.4),
(highly defined muscles:1.4), (visible muscle striations:1.3),
(ripped six pack abs:1.4), (vascular arms:1.2),
(muscular thighs:1.3), (toned calves:1.2),
(low body fat percentage:1.3),
competition ready physique,
tight sports bra, compression shorts,
posing in gym, flexing pose,
(dramatic side lighting:1.3), (strong shadows:1.2),
(professional sports photography:1.2),
highly detailed muscle texture,
photorealistic, 8k uhd, sharp focus

Negative:
(soft body, smooth body:1.5),
(no muscle definition:1.5),
(high body fat:1.4),
(deformed, ugly:1.5),
(low quality:1.4)
```

---

### 6.4.4 é«˜åˆ†è¾¨ç‡è¾“å‡ºç­–ç•¥

#### ç›®æ ‡ï¼šç”Ÿæˆ2048Ã—2048æˆ–æ›´é«˜åˆ†è¾¨ç‡

**æŒ‘æˆ˜**:
- ç›´æ¥ç”Ÿæˆé«˜åˆ†è¾¨ç‡ â†’ æ˜¾å­˜ä¸è¶³æˆ–é‡å¤é—®é¢˜
- ç®€å•æ”¾å¤§ â†’ ç»†èŠ‚æ¨¡ç³Š

**æœ€ä½³æ–¹æ¡ˆï¼šå¤šé˜¶æ®µæ”¾å¤§**

#### æ–¹æ¡ˆ1: Highres Fix + ESRGAN

```
Stage 1: ç”ŸæˆåŸºç¡€å›¾åƒ
  SDXL: 1024Ã—1024
  Steps: 30 (Base+Refiner)

Stage 2: Highres Fix
  Upscale by: 1.5x
  â†’ 1536Ã—1536
  Denoising: 0.4
  Steps: 20

Stage 3: ESRGANæ”¾å¤§
  R-ESRGAN 4x+
  1536Ã—1536 â†’ 3072Ã—3072

Stage 4: ç»†èŠ‚ä¿®å¤ï¼ˆå¯é€‰ï¼‰
  Tile ControlNet
  å±€éƒ¨å¢å¼ºç»†èŠ‚
```

#### WebUIå®Œæ•´é…ç½®

```yaml
txt2imgä¸»å‚æ•°:
  Width: 1024
  Height: 1024
  Steps: 30
  Sampler: DPM++ 2M Karras
  CFG: 7

Hires. fixå‹¾é€‰:
  Upscaler: Latent
  Hires steps: 20
  Denoising strength: 0.4
  Upscale by: 1.5

Refinerå‹¾é€‰:
  Refiner model: sd_xl_refiner_1.0
  Switch at: 0.8

æœ€ç»ˆè¾“å‡º: 1536Ã—1536

åå¤„ç† (Extrasæ ‡ç­¾):
  Upscaler: R-ESRGAN 4x+
  Resize: 2 (å†ç¿»å€)
```

#### æ˜¾å­˜éœ€æ±‚è®¡ç®—

$$
\text{VRAM} = \text{Model} + \text{Latent}(W, H) + \text{Gradient}
$$

```python
# å®æµ‹æ•°æ®
åˆ†è¾¨ç‡      æ— ä¼˜åŒ–    --medvram    --lowvram
1024Ã—1024   11.8GB    8.6GB        6.8GB
1536Ã—1536   16.2GB    12.1GB       9.5GB
2048Ã—2048   24.0GB    18.0GB       14.2GB

# æ¨èé…ç½®
8GBæ˜¾å¡:  1024Ã—1024 + --lowvram
12GBæ˜¾å¡: 1536Ã—1536 + --medvram
16GBæ˜¾å¡: 2048Ã—2048 + --medvram
24GBæ˜¾å¡: 2048Ã—2048 æ— éœ€ä¼˜åŒ–
```

---

## 6.5 SDXLæ‰¹é‡ç”Ÿäº§å®æˆ˜

### 6.5.1 æ‰¹é‡ç”ŸæˆAPI (Python)

```python
#!/usr/bin/env python3
"""
SDXLæ‰¹é‡ç”Ÿæˆè„šæœ¬
æ”¯æŒWebUI APIå’ŒComfyUI API
"""

import requests
import json
import base64
import time
from pathlib import Path
from typing import List, Dict
from PIL import Image
import io

class SDXLBatchGenerator:
    """SDXLæ‰¹é‡ç”Ÿæˆå™¨"""

    def __init__(
        self,
        api_url: str = "http://127.0.0.1:7860",
        backend: str = "webui"  # "webui" or "comfyui"
    ):
        self.api_url = api_url
        self.backend = backend

    def generate_webui(
        self,
        prompt: str,
        negative_prompt: str,
        width: int = 1024,
        height: int = 1024,
        steps: int = 30,
        cfg_scale: float = 7.0,
        seed: int = -1,
        use_refiner: bool = True,
        refiner_checkpoint: str = "sd_xl_refiner_1.0.safetensors",
        refiner_switch_at: float = 0.8
    ) -> Image.Image:
        """ä½¿ç”¨WebUI APIç”Ÿæˆå›¾åƒ"""

        payload = {
            "prompt": prompt,
            "negative_prompt": negative_prompt,
            "steps": steps,
            "cfg_scale": cfg_scale,
            "width": width,
            "height": height,
            "seed": seed,
            "sampler_name": "DPM++ 2M Karras",
            "scheduler": "Karras",

            # Refineré…ç½®
            "refiner_checkpoint": refiner_checkpoint if use_refiner else None,
            "refiner_switch_at": refiner_switch_at if use_refiner else 1.0,

            # SDXLç‰¹å®š
            "override_settings": {
                "CLIP_stop_at_last_layers": 2,
                "sd_vae": "sdxl_vae.safetensors"
            }
        }

        response = requests.post(
            f"{self.api_url}/sdapi/v1/txt2img",
            json=payload
        )

        if response.status_code != 200:
            raise RuntimeError(f"APIé”™è¯¯: {response.status_code}")

        result = response.json()
        image_data = base64.b64decode(result['images'][0])
        image = Image.open(io.BytesIO(image_data))

        return image

    def batch_generate_poses(
        self,
        base_prompt: str,
        poses: List[str],
        output_dir: str = "output/fitness_batch",
        **kwargs
    ) -> List[Dict]:
        """æ‰¹é‡ç”Ÿæˆä¸åŒå§¿åŠ¿"""

        Path(output_dir).mkdir(parents=True, exist_ok=True)
        results = []

        for i, pose in enumerate(poses):
            print(f"\n[{i+1}/{len(poses)}] ç”Ÿæˆ: {pose}")

            # æ„å»ºå®Œæ•´æç¤ºè¯
            prompt = base_prompt.format(pose=pose)

            # ç”Ÿæˆå›¾åƒ
            try:
                image = self.generate_webui(prompt, **kwargs)

                # ä¿å­˜
                filename = f"fitness_{i+1:03d}_{pose.replace(' ', '_')}.png"
                filepath = Path(output_dir) / filename
                image.save(filepath)

                print(f"  âœ“ ä¿å­˜: {filepath}")

                results.append({
                    "index": i + 1,
                    "pose": pose,
                    "filepath": str(filepath),
                    "size": image.size
                })

            except Exception as e:
                print(f"  âœ— å¤±è´¥: {e}")

            time.sleep(2)  # é¿å…è¿‡è½½

        return results


    def batch_generate_variations(
        self,
        prompt: str,
        count: int = 10,
        output_dir: str = "output/variations",
        **kwargs
    ) -> List[Dict]:
        """æ‰¹é‡ç”ŸæˆåŒæç¤ºè¯çš„ä¸åŒå˜ä½“ï¼ˆä¸åŒseedï¼‰"""

        Path(output_dir).mkdir(parents=True, exist_ok=True)
        results = []

        for i in range(count):
            print(f"\n[{i+1}/{count}] ç”Ÿæˆå˜ä½“ #{i+1}")

            # ä½¿ç”¨é€’å¢çš„seed
            seed = kwargs.get('seed', 100000) + i

            try:
                image = self.generate_webui(
                    prompt,
                    seed=seed,
                    **{k: v for k, v in kwargs.items() if k != 'seed'}
                )

                filename = f"variation_{i+1:03d}_seed{seed}.png"
                filepath = Path(output_dir) / filename
                image.save(filepath)

                print(f"  âœ“ ä¿å­˜: {filepath}")

                results.append({
                    "index": i + 1,
                    "seed": seed,
                    "filepath": str(filepath)
                })

            except Exception as e:
                print(f"  âœ— å¤±è´¥: {e}")

            time.sleep(1.5)

        return results


# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":

    generator = SDXLBatchGenerator(
        api_url="http://127.0.0.1:7860",
        backend="webui"
    )

    # ç¤ºä¾‹1: æ‰¹é‡ç”Ÿæˆä¸åŒå§¿åŠ¿
    print("="*60)
    print("æ‰¹é‡ç”Ÿæˆï¼š10ç§å¥èº«å§¿åŠ¿")
    print("="*60)

    base_prompt = """
    RAW photo, professional fitness photography,
    1 girl, 25 years old, asian fitness model,
    (athletic body:1.3), (toned abs:1.2),
    long black hair, high ponytail,
    sports bra, yoga pants,
    {pose},
    modern gym, natural lighting,
    photorealistic, highly detailed, 8k
    """

    poses = [
        "standing with hands on hips, confident pose",
        "performing squat, proper form, side view",
        "plank position, core engaged, from side",
        "stretching arms overhead, full body",
        "lunges pose, front leg bent, determined look",
        "lifting dumbbell, bicep curl, focused",
        "yoga tree pose, balanced on one leg",
        "running on treadmill, dynamic motion",
        "push up position, strong arms, from side",
        "sitting rest, towel on shoulder, smiling"
    ]

    results_poses = generator.batch_generate_poses(
        base_prompt=base_prompt,
        poses=poses,
        negative_prompt="""
        (deformed, ugly, bad anatomy:1.5),
        (bad hands:1.5),
        (low quality, blurry:1.4),
        watermark
        """,
        width=832,
        height=1216,
        steps=30,
        cfg_scale=7.0,
        seed=123456,
        use_refiner=True
    )

    print(f"\nå®Œæˆï¼å…±ç”Ÿæˆ {len(results_poses)} å¼ å›¾åƒ")


    # ç¤ºä¾‹2: æ‰¹é‡ç”Ÿæˆå˜ä½“
    print("\n" + "="*60)
    print("æ‰¹é‡ç”Ÿæˆï¼šåŒä¸€æç¤ºè¯çš„10ä¸ªå˜ä½“")
    print("="*60)

    prompt = """
    RAW photo, professional photography,
    1 girl, asian fitness model, athletic body, toned abs,
    sports bra, yoga pants, standing in gym,
    natural lighting, photorealistic, 8k
    """

    results_variations = generator.batch_generate_variations(
        prompt=prompt,
        count=10,
        negative_prompt="(deformed, ugly:1.5), (low quality:1.4)",
        width=1024,
        height=1024,
        steps=25,
        seed=100000
    )

    print(f"\nå®Œæˆï¼å…±ç”Ÿæˆ {len(results_variations)} ä¸ªå˜ä½“")

    # ç”ŸæˆæŠ¥å‘Š
    report = {
        "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
        "poses_batch": results_poses,
        "variations_batch": results_variations,
        "total_images": len(results_poses) + len(results_variations)
    }

    with open("output/batch_report.json", "w", encoding="utf-8") as f:
        json.dump(report, f, indent=2, ensure_ascii=False)

    print(f"\næŠ¥å‘Šå·²ä¿å­˜: output/batch_report.json")
```

---

### 6.5.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### ä¼˜åŒ–1: æ¨¡å‹é¢„åŠ è½½

```python
# åœ¨WebUIå¯åŠ¨æ—¶é¢„åŠ è½½æ¨¡å‹
# webui-user.bat
set COMMANDLINE_ARGS=--xformers --medvram --api --nowebui

# APIæ¨¡å¼è¿è¡Œï¼Œå‡å°‘Webç•Œé¢å¼€é”€
```

#### ä¼˜åŒ–2: å¹¶å‘ç”Ÿæˆ

```python
import concurrent.futures

def parallel_generate(prompts: List[str], max_workers: int = 2):
    """å¹¶å‘ç”Ÿæˆå¤šä¸ªå›¾åƒ"""

    def generate_one(prompt):
        return generator.generate_webui(prompt, ...)

    with concurrent.futures.ThreadPoolExecutor(
        max_workers=max_workers
    ) as executor:
        futures = [executor.submit(generate_one, p) for p in prompts]

        results = []
        for future in concurrent.futures.as_completed(futures):
            try:
                image = future.result()
                results.append(image)
            except Exception as e:
                print(f"ç”Ÿæˆå¤±è´¥: {e}")

        return results

# æ³¨æ„ï¼šmax_workersä¸å®œè¿‡é«˜ï¼Œå—é™äºæ˜¾å­˜
# 8GBæ˜¾å¡: max_workers=1
# 16GBæ˜¾å¡: max_workers=2
# 24GBæ˜¾å¡: max_workers=3
```

---

## 6.6 æœ¬ç« æ€»ç»“

### æ ¸å¿ƒçŸ¥è¯†ç‚¹

```
âœ… SDXLæ¶æ„åŸç†ï¼ˆ3.5Bå‚æ•°ï¼ŒåŒCLIPç¼–ç å™¨ï¼‰
âœ… Base + Refinerå·¥ä½œæµ
âœ… çœŸäººå›¾åƒè´¨é‡ä¼˜åŒ–ï¼ˆçš®è‚¤ã€æ‰‹éƒ¨ã€è‚Œè‚‰ï¼‰
âœ… é«˜åˆ†è¾¨ç‡ç”Ÿæˆç­–ç•¥
âœ… æ‰¹é‡ç”Ÿäº§APIå®ç°
âœ… æ€§èƒ½ä¼˜åŒ–æŠ€å·§
```

### SDXL vs SD 1.5 å†³ç­–

| åœºæ™¯ | æ¨èæ¨¡å‹ | åŸå›  |
|------|---------|------|
| å­¦ä¹ æµ‹è¯• | SD 1.5 | æ˜¾å­˜å‹å¥½ï¼Œé€Ÿåº¦å¿« |
| çœŸäººç…§ç‰‡ | SDXL â­â­â­â­â­ | è´¨é‡æ˜¾è‘—æ›´å¥½ |
| è‰ºæœ¯åˆ›ä½œ | SDXL â­â­â­â­â­ | ç»†èŠ‚ä¸°å¯Œ |
| æ‰¹é‡ç”Ÿäº§ | SDXL + API | ä¼ä¸šæ ‡å‡† |
| 6GBæ˜¾å¡ | SD 1.5 | SDXLæ˜¾å­˜ä¸è¶³ |
| 12GB+æ˜¾å¡ | SDXL | å……åˆ†å‘æŒ¥æ€§èƒ½ |

### é»„é‡‘é…ç½®ï¼ˆçœŸäººå¥èº«ç…§ç‰‡ï¼‰

```yaml
Model: RealVisXL_V4.0.safetensors
VAE: sdxl_vae.safetensors

txt2img:
  Width: 832
  Height: 1216  (3:4äººåƒæ¯”ä¾‹)
  Steps: 30
  Sampler: DPM++ 2M Karras
  CFG: 7.0
  CLIP skip: 2

Refiner:
  Model: sd_xl_refiner_1.0
  Switch at: 0.8

æç¤ºè¯:
  å¼ºè°ƒ: athletic body, toned abs, muscle definition
  å…‰å½±: dramatic lighting, side lighting
  è´¨é‡: RAW photo, professional photography

è´Ÿé¢ï¼š
  å¼ºåŒ–: bad hands, deformed, low quality
```

### å®æˆ˜æ£€æŸ¥æ¸…å•

- [ ] ä¸‹è½½SDXL Baseå’ŒRefineræ¨¡å‹
- [ ] é…ç½®SDXL VAE
- [ ] ç”Ÿæˆç¬¬ä¸€å¼ 1024Ã—1024å›¾åƒ
- [ ] ä½¿ç”¨Refinerç²¾ä¿®
- [ ] ä¼˜åŒ–çœŸäººçš®è‚¤è´¨æ„Ÿ
- [ ] æ‰¹é‡ç”Ÿæˆ10å¼ ä¸åŒå§¿åŠ¿
- [ ] è¾“å‡º2048Ã—2048é«˜æ¸…å›¾

---

## 6.7 ä¸‹ä¸€æ­¥

**æœ¬ç« å®Œæˆåï¼Œä½ åº”è¯¥èƒ½å¤Ÿ**:
- âœ… å®Œå…¨ç†è§£SDXLæ¶æ„
- âœ… ç†Ÿç»ƒä½¿ç”¨Base+Refinerå·¥ä½œæµ
- âœ… ç”Ÿæˆé«˜è´¨é‡çœŸäººå¥èº«ç…§ç‰‡
- âœ… æ‰¹é‡ç”Ÿäº§å›¾åƒ

**ä¸‹ä¸€ç« é¢„å‘Š**:
å­¦ä¹ SD 1.5ç»å…¸æ¨¡å‹çš„ä½¿ç”¨æŠ€å·§ï¼Œä»¥åŠå¦‚ä½•åœ¨ä½æ˜¾å­˜ç¯å¢ƒä¸‹é«˜æ•ˆç”Ÿæˆï¼

**ä¸‹ä¸€ç« **: [ç¬¬7ç«  Stable Diffusion 1.5ç»å…¸å®æˆ˜](../ç¬¬07ç« _SD1.5å®æˆ˜/README.md)

---

**èµ„æºä¸‹è½½**:
- ğŸ“¥ SDXLå·¥ä½œæµæ¨¡æ¿
- ğŸ“¥ çœŸäººå¥èº«æç¤ºè¯åº“
- ğŸ“¥ æ‰¹é‡ç”Ÿæˆè„šæœ¬

**ä¿å­˜ä½ç½®**: `/tmp/AIGCå†…å®¹ç”Ÿæˆèµ„æº/SDXL/`

# 第36章 常见问题排查手册

> **难度**: ⭐⭐⭐ | **推荐度**: ⭐⭐⭐⭐⭐

## 36.1 图像生成问题

### 36.1.1 黑图/全白图

**症状**: 生成的图像全黑或全白

**原因 & 解决**:
```python
# 原因1: VAE问题
解决: 更换VAE
pipe.vae = AutoencoderKL.from_pretrained("stabilityai/sd-vae-ft-mse")

# 原因2: CFG过高
解决: 降低CFG Scale
guidance_scale = 7.0  # 从15降到7

# 原因3: Steps过少
解决: 增加Steps
num_inference_steps = 30  # 从10增到30

# 原因4: Negative prompt过强
解决: 简化negative prompt
negative_prompt = "low quality"  # 不要堆砌几百个词
```

### 36.1.2 图像模糊/不清晰

**解决方案**:
```python
# 方法1: Highres Fix
使用img2img放大
denoising_strength = 0.4
scale = 2.0

# 方法2: 使用Upscaler
from realesrgan import RealESRGAN
upscaler = RealESRGAN(model_path="RealESRGAN_x4plus.pth")
upscaled = upscaler.predict(image)

# 方法3: 提升生成分辨率
width, height = 1024, 1024  # 从512提升

# 方法4: 增加Steps
steps = 50  # 从30增加到50
```

### 36.1.3 颜色异常

**症状**: 偏色/过饱和/灰暗

**解决**:
```python
# 问题1: VAE未加载
解决: 明确指定VAE
pipe.vae = AutoencoderKL.from_pretrained("vae-ft-mse")

# 问题2: 色彩空间问题
from PIL import Image
image = Image.open("output.png").convert("RGB")  # 确保RGB

# 问题3: 提示词影响
避免: "black and white", "monochrome"
添加: "vibrant colors", "colorful"
```

---

## 36.2 性能问题

### 36.2.1 CUDA OOM (显存不足)

**错误**: `RuntimeError: CUDA out of memory`

**解决方案**:
```python
# 方法1: 降低分辨率
width, height = 512, 512  # 从1024降低

# 方法2: 减小batch size
batch_size = 1  # 从4降到1

# 方法3: 启用优化
pipe.enable_xformers_memory_efficient_attention()
pipe.enable_vae_slicing()
pipe.enable_attention_slicing(1)

# 方法4: CPU Offload
pipe.enable_model_cpu_offload()

# 方法5: 使用float16
pipe = pipeline.from_pretrained(model, torch_dtype=torch.float16)

# 方法6: 清理显存
import gc
torch.cuda.empty_cache()
gc.collect()

# 方法7: 换小模型
SD 1.5 (4GB VRAM) vs SDXL (12GB+ VRAM)
```

### 36.2.2 生成速度慢

**优化方案**:
```python
# 方法1: 减少Steps
steps = 20  # 从50降到20,质量可接受时

# 方法2: 更快采样器
from diffusers import DPMSolverMultistepScheduler
pipe.scheduler = DPMSolverMultistepScheduler.from_config(pipe.scheduler.config)

# 方法3: Torch Compile
pipe.unet = torch.compile(pipe.unet)

# 方法4: xformers
pipe.enable_xformers_memory_efficient_attention()

# 方法5: 批处理
images = pipe(prompt=[p1, p2, p3, p4]).images  # 一次生成4张
```

---

## 36.3 ControlNet问题

### 36.3.1 ControlNet不生效

**排查清单**:
```python
# ✓ 检查1: 权重是否过低
controlnet_conditioning_scale = 0.8  # 不要<0.3

# ✓ 检查2: 模型匹配
Canny条件图 → 必须用Canny模型
OpenPose骨架 → 必须用OpenPose模型

# ✓ 检查3: 条件图是否正确
# 预览预处理结果,确认可见
canny_image.save("debug_canny.png")

# ✓ 检查4: Start/End范围
control_start = 0.0
control_end = 0.8  # 不要太小

# ✓ 检查5: CFG不要过低
guidance_scale = 7.0  # 不要<5
```

### 36.3.2 生成图扭曲

**原因**: 多ControlNet权重冲突

**解决**:
```python
# 方法1: 降低次要ControlNet权重
controlnet_conditioning_scale = [1.0, 0.5, 0.3]  # 主次分明

# 方法2: 移除冲突的ControlNet
# 如OpenPose + Depth可能冲突

# 方法3: 调整Control End
control_end = [0.7, 0.5, 0.3]  # 早期结束次要控制
```

---

## 36.4 LoRA问题

### 36.4.1 LoRA无效

**排查**:
```python
# 检查1: 触发词正确?
提示词必须包含训练时的触发词
如训练时文件夹名: 15_nike_coach
→ 提示词必须有"nike_coach"

# 检查2: 权重是否够?
<lora:model:0.8>  # 不要<0.5

# 检查3: 基础模型匹配?
SD 1.5 LoRA 不能用于 SDXL

# 检查4: LoRA文件是否正确
文件大小应该10-100MB
检查文件是否完整下载
```

### 36.4.2 LoRA过拟合

**症状**: 只能复现训练图,新场景失败

**补救**:
```python
# 方法1: 降低LoRA权重
<lora:model:0.4>  # 从0.9降低

# 方法2: 与其他LoRA混合
<lora:base_style:0.6><lora:character:0.4>

# 方法3: 详细提示词
"character_name in completely different scene, outdoor park, sunset"
# 强调"different", "new"等

# 长期解决: 重新训练
- 增加数据多样性
- 减少epoch
- 降低学习率
```

---

## 36.5 视频生成问题

### 36.5.1 运动不自然

**解决**:
```python
# Runway/Pika/Kling通用技巧

# 技巧1: 详细描述运动
❌ "person moves"
✅ "person slowly bends knees, descending smoothly"

# 技巧2: 强调流畅性
添加关键词: "smooth", "controlled", "natural"

# 技巧3: 降低运动强度
Kling: motion_intensity = "medium"  # 不要"high"
Pika: motion = 2  # 不要4

# 技巧4: 参考图质量
确保参考图清晰,姿势标准
```

### 36.5.2 视频抖动/闪烁

**原因 & 解决**:
```python
# 原因1: 运动强度过高
解决: 降低运动参数

# 原因2: 参考图问题
解决: 使用高质量、光线均匀的参考图

# 原因3: 提示词冲突
解决: 简化提示词,避免矛盾描述
❌ "fast movement but stay still"

# 原因4: 工具限制
某些工具对特定场景不擅长
→ 换工具: Runway → Kling (真人动作)
```

---

## 36.6 音频问题

### 36.6.1 Suno音乐不符合预期

**优化提示词**:
```python
# 技巧1: 明确BPM
"upbeat electronic music, 128 BPM"  # 具体数字

# 技巧2: 指定乐器
"piano and strings, no drums"

# 技巧3: 参考风格
"in the style of Hans Zimmer"
"similar to epic trailer music"

# 技巧4: 强调用途
"perfect for fitness video background music"

# 技巧5: 多次生成选最佳
一次生成2个版本,选择更好的
```

### 36.6.2 ElevenLabs音效不够真实

**改进方法**:
```python
# 方法1: 更详细描述
❌ "dumbbell sound"
✅ "heavy iron dumbbell dropping on thick rubber gym mat, deep thud with slight bounce"

# 方法2: 强调材质
"metallic", "rubber", "wooden" 等

# 方法3: 描述空间
"in large gym with echo" vs "in small room, dry sound"

# 方法4: 多生成几次
音效生成快,多试几次选最佳
```

---

## 36.7 API问题

### 36.7.1 Rate Limit

**错误**: `429 Too Many Requests`

**解决**:
```python
import time
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=4, max=60)
)
def api_call_with_retry(client, prompt):
    try:
        return client.generate(prompt)
    except RateLimitError as e:
        print(f"Rate limit hit, retrying...")
        raise

# 使用
result = api_call_with_retry(client, prompt)

# 或添加延迟
for prompt in prompts:
    result = client.generate(prompt)
    time.sleep(2)  # 每次间隔2秒
```

### 36.7.2 超时问题

**解决**:
```python
# 方法1: 增加timeout
response = requests.post(url, json=data, timeout=300)  # 5分钟

# 方法2: 异步轮询
def poll_result(task_id, max_wait=600):
    start = time.time()
    while time.time() - start < max_wait:
        status = get_status(task_id)
        if status == "completed":
            return get_result(task_id)
        time.sleep(10)
    raise TimeoutError("Generation timeout")

# 方法3: Webhook回调
# 提交任务时提供callback_url
# 生成完成后API主动推送结果
```

---

## 36.8 快速诊断流程

```python
def diagnose_issue(problem_type):
    """问题诊断决策树"""

    if problem_type == "黑图":
        return [
            "1. 检查VAE",
            "2. 降低CFG (7.0)",
            "3. 增加Steps (30+)",
            "4. 简化negative prompt"
        ]

    elif problem_type == "OOM":
        return [
            "1. 降低分辨率 (1024→512)",
            "2. batch_size=1",
            "3. enable_xformers()",
            "4. enable_vae_slicing()",
            "5. 换小模型或CPU offload"
        ]

    elif problem_type == "ControlNet无效":
        return [
            "1. 权重>=0.7",
            "2. 检查模型匹配",
            "3. 预览条件图",
            "4. CFG>=7.0"
        ]

    elif problem_type == "LoRA无效":
        return [
            "1. 检查触发词",
            "2. 权重>=0.7",
            "3. 检查基础模型版本",
            "4. 验证文件完整性"
        ]

    else:
        return ["查看完整手册对应章节"]

# 使用
steps = diagnose_issue("OOM")
for step in steps:
    print(step)
```

---

## 36.9 总结

**核心排查原则**:
1. **由简到繁**: 先检查简单配置,再查复杂逻辑
2. **对比排除**: 最小化改动,逐项测试
3. **查看日志**: 错误信息往往直接指向问题
4. **社区求助**: Reddit/Discord/GitHub Issues

**常见问题Top 5**:
1. CUDA OOM → 降分辨率/enable优化
2. 黑图 → 换VAE/降CFG
3. ControlNet无效 → 检查权重/模型匹配
4. 生成慢 → 减Steps/换采样器/xformers
5. LoRA无效 → 检查触发词/权重

**建议**: 建立个人问题库,记录遇到的问题和解决方案,长期积累经验。

遇到问题不要慌,90%的问题都在本章有答案!
